<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electronic Shop Inventory</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Enhanced background with subtle pattern and gradient */
            background-color: #f0f4f8; /* Light blue-gray */
            background-image: radial-gradient(circle at top left, #e0e7ff, transparent),
                              radial-gradient(circle at bottom right, #bfdbfe, transparent);
            background-size: 800px 800px;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        /* Keyframes for animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInFromTop {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-slideInFromTop {
            animation: slideInFromTop 0.6s ease-out forwards;
        }
        .animate-popIn {
            animation: popIn 0.3s ease-out forwards;
        }

        .scroll-container {
            max-height: 65vh; /* Adjusted for more vertical space */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .btn-base {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* More rounded */
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* More professional transition */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Softer shadow */
            border: 1px solid transparent; /* For consistent sizing */
        }
        .btn-primary {
            background-color: #4F46E5; /* Deeper Indigo 600 */
            background-image: linear-gradient(to right, #6366F1, #4F46E5); /* Subtle gradient */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338CA; /* Deeper Indigo 700 */
            background-image: linear-gradient(to right, #4F46E5, #4338CA);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); /* Stronger shadow on hover */
        }
        .btn-secondary {
            background-color: #E2E8F0; /* Slate 200 */
            color: #475569; /* Slate 700 */
        }
        .btn-secondary:hover {
            background-color: #CBD5E1; /* Slate 300 */
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .btn-danger {
            background-color: #EF4444; /* Red 500 */
            background-image: linear-gradient(to right, #EF4444, #DC2626);
            color: white;
        }
        .btn-danger:hover {
            background-color: #DC2626; /* Red 600 */
            background-image: linear-gradient(to right, #DC2626, #B91C1C);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .btn-outline {
            background-color: transparent;
            color: #6366F1; /* Indigo 500 */
            border-color: #6366F1;
            border-width: 1px;
            box-shadow: none;
        }
        .btn-outline:hover {
            background-color: #EEF2FF; /* Indigo 50 */
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .input-field {
            padding: 0.85rem; /* Slightly more padding */
            border: 1px solid #CBD5E1; /* Slate 300 */
            border-radius: 0.625rem; /* More rounded */
            width: 100%;
            background-color: white;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            border-color: #6366F1; /* Indigo 500 */
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.4); /* Stronger, more vibrant focus ring */
            outline: none;
        }
        .table-header {
            background-color: #475569; /* Slate 700 */
            font-weight: 700;
            color: #F8FAFC; /* Slate 50 */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table-row {
            border-bottom: 1px solid #E2E8F0; /* Subtle row divider */
        }
        .table-row:nth-child(odd) {
            background-color: #F8FAFC; /* Slate 50 */
        }
        .table-row:nth-child(even) {
            background-color: white;
        }
        .table-row:hover {
            background-color: #EEF2FF; /* Indigo 50 */
            transform: translateY(-2px); /* Slight lift on hover */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* More noticeable shadow on hover */
            transition: all 0.15s ease-in-out;
        }
        .quantity-btn {
            width: 36px; /* Larger touch target */
            height: 36px; /* Larger touch target */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            font-size: 1.1rem; /* Larger font */
            font-weight: 700;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15); /* More pronounced shadow */
        }
        .quantity-btn:active {
            transform: scale(0.9); /* More pronounced active state */
        }
        .quantity-btn-minus {
            background-color: #FEE2E2; /* Red 100 */
            color: #DC2626; /* Red 600 */
        }
        .quantity-btn-minus:hover {
            background-color: #FECACA; /* Red 200 */
        }
        .quantity-btn-plus {
            background-color: #D1FAE5; /* Green 100 */
            color: #059669; /* Green 600 */
        }
        .quantity-btn-plus:hover {
            background-color: #A7F3D0; /* Green 200 */
        }
        .icon {
            width: 1.25rem; /* Standard icon size */
            height: 1.25rem;
            stroke-width: 2; /* Standard stroke width for Lucide */
        }

        /* Message box specific styles */
        .message-box {
            border-radius: 0.75rem;
            padding: 1.25rem;
            font-size: 1.125rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.4s ease-out forwards;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .message-box.success {
            background-color: #D1FAE5; /* Green 100 */
            color: #059669; /* Green 600 */
            border: 1px solid #A7F3D0; /* Green 200 */
        }
        .message-box.error {
            background-color: #FEE2E2; /* Red 100 */
            color: #DC2626; /* Red 600 */
            border: 1px solid #FECACA; /* Red 200 */
        }

        /* Details/Summary styling for collapsible form */
        details {
            background-color: #F8FAFC; /* Light background for the collapsible section */
            border: 1px solid #E2E8F0; /* Light border */
            border-radius: 1rem; /* More rounded */
            margin-bottom: 2.5rem; /* Space below the form */
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08); /* More prominent shadow */
            transition: all 0.3s ease-in-out;
        }

        details[open] {
            background-color: white; /* White background when open */
            border-color: #CBD5E1; /* Slightly darker border when open */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); /* More prominent shadow when open */
        }

        summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            font-size: 1.6rem; /* Larger font for summary title */
            font-weight: 700;
            color: #334155; /* Slate 800 */
            cursor: pointer;
            outline: none;
            user-select: none;
            border-bottom: 1px solid transparent; /* To prevent double border when open */
        }

        details[open] summary {
            border-bottom: 1px solid #E2E8F0; /* Border at the bottom of summary when open */
        }

        summary::-webkit-details-marker {
            display: none; /* Hide default marker */
        }

        summary .arrow-icon {
            transition: transform 0.3s ease-in-out;
        }

        details[open] summary .arrow-icon {
            transform: rotate(90deg); /* Rotate arrow when open */
        }

        /* Navbar specific styles */
        .navbar {
            background-color: #2F3B4E; /* Darker, professional background */
            color: white; /* White text for contrast */
            padding: 1rem 2.5rem; /* Increased padding */
            border-radius: 1rem; /* More rounded */
            margin-bottom: 2.5rem;
            display: flex;
            flex-direction: column; /* Stack on small screens */
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem; /* More space between elements */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); /* Stronger, deeper shadow */
            animation: slideInFromTop 0.6s ease-out forwards; /* Slide down animation */
        }

        .navbar .app-title {
            font-size: 2.5rem; /* text-4xl */
            font-weight: 800; /* font-extrabold */
            color: #E0E7FF; /* Light indigo for title */
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem; /* Space between icon and text */
        }

        .navbar .app-subtitle {
            font-size: 1.125rem; /* text-lg */
            color: #CBD5E1; /* Lighter gray for subtitle */
            margin-top: 0;
        }

        .navbar .user-info {
            color: #E2E8F0; /* Light gray for user info */
            font-size: 1rem; /* Slightly larger font size */
        }

        .navbar .user-id-badge {
            background-color: #4B5563; /* Darker background for ID */
            color: #F8FAFC; /* Lighter text for ID */
            padding: 0.35rem 0.9rem; /* More padding */
            border-radius: 0.625rem; /* More rounded */
            font-size: 0.875rem; /* Slightly larger font for ID */
        }

        .navbar .btn-logout {
            background-color: #EF4444; /* Red for logout */
            color: white;
            padding: 0.6rem 1.2rem; /* Adjusted padding */
            border-radius: 0.625rem; /* More rounded */
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .navbar .btn-logout:hover {
            background-color: #DC2626; /* Darker red on hover */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        @media (min-width: 640px) { /* sm breakpoint */
            .navbar {
                flex-direction: row;
                padding: 1rem 3rem; /* More horizontal padding on larger screens */
            }
            .navbar .app-title {
                font-size: 3rem; /* Larger on desktop */
            }
            .navbar .app-subtitle {
                font-size: 1.25rem; /* Larger on desktop */
            }
            .navbar .user-info {
                font-size: 1.05rem;
            }
            .navbar .user-id-badge {
                font-size: 0.9rem;
            }
            .navbar .btn-logout {
                padding: 0.7rem 1.3rem;
            }
        }
        /* New/Adjusted styles for image card */
        .item-image-container {
            width: 60px; /* Fixed width for the image container */
            height: 60px; /* Fixed height for the image container */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #F0F4F8; /* Light background for the image card */
            border-radius: 0.75rem; /* More rounded corners */
            overflow: hidden; /* Ensure image doesn't spill out */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow for card effect */
            flex-shrink: 0; /* Prevent shrinking in flex container */
            border: 1px solid #E2E8F0; /* Subtle border */
        }
        .item-image {
            width: 100%; /* Image takes full width of its container */
            height: 100%; /* Image takes full height of its container */
            object-fit: cover; /* Ensures image covers the area without distortion */
            border-radius: 0.75rem; /* Match container border-radius */
        }
    </style>
</head>
<body class="min-h-screen font-sans flex flex-col items-center p-4 sm:p-6 lg:p-10">

    <div id="app-container" class="w-full max-w-6xl bg-white shadow-2xl rounded-2xl p-6 sm:p-8 lg:p-10 mb-10 border border-gray-100 animate-fadeIn">
        <!-- Navbar Section -->
        <nav class="navbar">
            <div class="text-center sm:text-left">
                <h1 class="app-title">
                    <i data-lucide="package" class="icon w-8 h-8 text-indigo-200"></i>
                    Electronic Shop Inventory
                </h1>
                <p class="app-subtitle">Manage Your Stock Efficiently</p>
            </div>
            <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                <p class="user-info hidden md:block">
                    Logged in as: <span id="loggedInUsernameDisplay" class="user-id-badge select-all"></span>
                </p>
                <button id="goToBillingButton" class="btn-base btn-secondary px-5 py-2 text-sm">
                    <i data-lucide="receipt" class="icon w-5 h-5"></i> Go to Billing
                </button>
                <button id="logoutButton" class="btn-base btn-danger px-5 py-2 text-sm">
                    <i data-lucide="log-out" class="icon w-5 h-5"></i> Logout
                </button>
            </div>
        </nav>

        <!-- Message Box (will be dynamically updated) -->
        <div id="messageBox" class="hidden message-box text-center mb-8"></div>

        <!-- Collapsible Add/Edit Item Form -->
        <details id="itemFormDetails" class="animate-fadeIn" style="animation-delay: 0.2s;">
            <summary>
                <span class="flex items-center gap-3">
                    <i data-lucide="plus-circle" class="icon w-7 h-7 text-indigo-600"></i>
                    <span id="formTitle">Add New Inventory Item</span>
                </span>
                <i data-lucide="chevron-right" class="icon arrow-icon w-6 h-6 text-gray-500"></i>
            </summary>
            <div class="p-6 sm:p-8">
                <form id="itemForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 lg:gap-8">
                    <div>
                        <label for="itemName" class="block text-gray-800 text-sm font-semibold mb-2">Item Name <span class="text-red-500">*</span></label>
                        <input type="text" id="itemName" class="input-field" placeholder="e.g., Samsung Galaxy S24, Sony WH-1000XM5" required>
                    </div>
                    <div>
                        <label for="itemQuantity" class="block text-gray-800 text-sm font-semibold mb-2">Quantity <span class="text-red-500">*</span></label>
                        <input type="number" id="itemQuantity" class="input-field" placeholder="e.g., 10, 50" min="0" required>
                    </div>
                    <div>
                        <label for="itemPrice" class="block text-gray-800 text-sm font-semibold mb-2">Price (INR) <span class="text-red-500">*</span></label>
                        <input type="number" id="itemPrice" class="input-field" placeholder="e.g., 50000.00" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label for="itemImageUrl" class="block text-gray-800 text-sm font-semibold mb-2">Image URL (Optional)</label>
                        <input type="url" id="itemImageUrl" class="input-field" placeholder="e.g., https://example.com/product.jpg">
                    </div>
                    <div class="md:col-span-2">
                        <label for="itemDescription" class="block text-gray-800 text-sm font-semibold mb-2">Description (Optional)</label>
                        <textarea id="itemDescription" class="input-field h-28 resize-y" placeholder="e.g., 15-inch, 8GB RAM, 256GB SSD, Space Gray"></textarea>
                    </div>
                    <div class="md:col-span-2 flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancelEditButton" class="btn-base btn-secondary px-7 py-2.5">
                            Cancel Edit
                        </button>
                        <button type="submit" id="submitFormButton" class="btn-base btn-primary px-7 py-2.5">
                            <i data-lucide="save" class="icon"></i> <span id="submitButtonText">Add Item</span>
                        </button>
                    </div>
                </form>
            </div>
        </details>

        <!-- Inventory List Section -->
        <div class="p-6 sm:p-8 bg-white border border-gray-200 rounded-xl shadow-lg animate-fadeIn" style="animation-delay: 0.4s;">
            <h2 class="text-3xl font-bold text-gray-800 mb-7 text-center">Current Inventory Overview</h2>
            
            <!-- Search Bar -->
            <div class="mb-6 relative">
                <input type="text" id="inventorySearchInput" class="input-field pl-10 pr-4 py-2.5" placeholder="Search by item name or description...">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
            </div>

            <div id="inventoryListContainer">
                <!-- Inventory items will be rendered here by JavaScript -->
                <p class="text-gray-500 text-center py-12 text-lg">No items in inventory. Add some items using the form above!</p>
            </div>
        </div>
    </div>

    <script>
        // Check for logged-in user on page load
        const loggedInUser = sessionStorage.getItem('loggedInUser');
        if (!loggedInUser) {
            window.location.href = 'index.html'; // Redirect to login if not logged in
        }

        // Global state for the application
        window.appState = {
            loggedInUser: loggedInUser,
            inventory: [],
            itemName: '',
            itemQuantity: '',
            itemPrice: '',
            itemDescription: '',
            itemImageUrl: '',
            editingItem: null,
            message: { text: '', type: '' },
            isFormOpen: false,
            searchTerm: '' // New state for search term
        };

        // DOM Elements (cached for performance)
        const loggedInUsernameDisplay = document.getElementById('loggedInUsernameDisplay');
        const logoutButton = document.getElementById('logoutButton');
        const goToBillingButton = document.getElementById('goToBillingButton');
        const messageBox = document.getElementById('messageBox');
        const itemFormDetails = document.getElementById('itemFormDetails');
        const formTitle = document.getElementById('formTitle');
        const itemForm = document.getElementById('itemForm');
        const itemNameInput = document.getElementById('itemName');
        const itemQuantityInput = document.getElementById('itemQuantity');
        const itemPriceInput = document.getElementById('itemPrice');
        const itemDescriptionInput = document.getElementById('itemDescription');
        const itemImageUrlInput = document.getElementById('itemImageUrl');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const submitFormButton = document.getElementById('submitFormButton');
        const submitButtonText = document.getElementById('submitButtonText');
        const inventoryListContainer = document.getElementById('inventoryListContainer');
        const inventorySearchInput = document.getElementById('inventorySearchInput'); // New search input

        // --- Local Storage Functions ---
        const getAllUsers = () => {
            const usersJson = localStorage.getItem('electronicShopUsers');
            return usersJson ? JSON.parse(usersJson) : {};
        };

        const saveAllUsers = (users) => {
            localStorage.setItem('electronicShopUsers', JSON.stringify(users));
        };

        const saveUserInventory = () => {
            let users = getAllUsers();
            if (users[window.appState.loggedInUser]) {
                users[window.appState.loggedInUser].inventory = window.appState.inventory;
                saveAllUsers(users);
                console.log(`[LOCAL STORAGE] Inventory for ${window.appState.loggedInUser} saved.`);
            }
        };

        const loadUserInventory = () => {
            let users = getAllUsers();
            if (users[window.appState.loggedInUser]) {
                window.appState.inventory = users[window.appState.loggedInUser].inventory || [];
                window.appState.inventory.sort((a, b) => a.name.localeCompare(b.name));
                console.log(`[LOCAL STORAGE] Inventory for ${window.appState.loggedInUser} loaded:`, window.appState.inventory.length, 'items.');
            } else {
                window.appState.inventory = [];
                console.warn(`[LOCAL STORAGE] No inventory found for ${window.appState.loggedInUser}, starting with empty list.`);
            }
        };

        // Function to render the entire application UI based on appState
        window.renderApp = () => {
            // Update logged-in username display
            loggedInUsernameDisplay.textContent = window.appState.loggedInUser;

            // Message Box Display
            if (window.appState.message.text) {
                messageBox.classList.remove('hidden', 'success', 'error');
                messageBox.classList.add(window.appState.message.type);
                messageBox.innerHTML = `<i data-lucide="${window.appState.message.type === 'success' ? 'check-circle' : 'alert-triangle'}" class="icon w-6 h-6"></i><span>${window.appState.message.text}</span>`;
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                    window.appState.message = { text: '', type: '' }; // Clear message in state
                }, 3000);
            } else {
                messageBox.classList.add('hidden');
            }

            // Update Form Fields and State
            itemNameInput.value = window.appState.itemName;
            itemQuantityInput.value = window.appState.itemQuantity;
            itemPriceInput.value = window.appState.itemPrice;
            itemDescriptionInput.value = window.appState.itemDescription;
            itemImageUrlInput.value = window.appState.itemImageUrl;

            if (window.appState.editingItem) {
                formTitle.textContent = 'Edit Item Details';
                submitButtonText.textContent = 'Update Item';
                cancelEditButton.classList.remove('hidden');
            } else {
                formTitle.textContent = 'Add New Inventory Item';
                submitButtonText.textContent = 'Add Item';
                cancelEditButton.classList.add('hidden');
            }

            // Set details element open state
            itemFormDetails.open = window.appState.isFormOpen;

            // Filter inventory based on search term
            const lowerCaseSearchTerm = window.appState.searchTerm.toLowerCase();
            const filteredInventory = window.appState.inventory.filter(item =>
                item.name.toLowerCase().includes(lowerCaseSearchTerm) ||
                (item.description && item.description.toLowerCase().includes(lowerCaseSearchTerm))
            );

            // Render Inventory List
            if (filteredInventory.length === 0) {
                inventoryListContainer.innerHTML = '<p class="text-gray-500 text-center py-12 text-lg">No items found matching your search. Try adjusting your filters or add new items!</p>';
            } else {
                let tableHtml = `
                    <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-md scroll-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="table-header">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Image</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Item Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Quantity</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Price (INR)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Description</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Last Updated</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                filteredInventory.forEach(item => {
                    tableHtml += `
                        <tr class="table-row">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="item-image-container">
                                    <img src="${item.imageUrl || `https://placehold.co/60x60/E0E7FF/4F46E5?text=No+Image`}"
                                        alt="${item.name}"
                                        class="item-image"
                                        onerror="this.onerror=null;this.src='https://placehold.co/60x60/E0E7FF/4F46E5?text=No+Image';"
                                    >
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                                <div class="flex items-center space-x-2">
                                    <button data-id="${item.id}" data-type="deduct" class="quantity-btn quantity-btn-minus">
                                        <i data-lucide="minus" class="icon w-4 h-4"></i>
                                    </button>
                                    <span class="font-semibold text-base">${item.quantity}</span>
                                    <button data-id="${item.id}" data-type="add" class="quantity-btn quantity-btn-plus">
                                        <i data-lucide="plus" class="icon w-4 h-4"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">₹${item.price.toFixed(2)}</td>
                            <td class="px-6 py-4 text-sm text-gray-700 max-w-xs overflow-hidden text-ellipsis">${item.description || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${item.lastUpdated ? new Date(item.lastUpdated).toLocaleString() : '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-left text-sm font-medium">
                                <div class="flex space-x-3">
                                    <button data-id="${item.id}" class="edit-btn text-indigo-600 hover:text-indigo-800 font-semibold hover:underline flex items-center gap-1">
                                        <i data-lucide="edit" class="icon w-4 h-4"></i> Edit
                                    </button>
                                    <button data-id="${item.id}" class="delete-btn text-red-600 hover:text-red-800 font-semibold hover:underline flex items-center gap-1">
                                        <i data-lucide="trash-2" class="icon w-4 h-4"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table></div>`;
                inventoryListContainer.innerHTML = tableHtml;

                // Attach event listeners to newly rendered buttons
                inventoryListContainer.querySelectorAll('.quantity-btn').forEach(button => {
                    button.onclick = (event) => window.handleQuantityChange(event.currentTarget.dataset.id, event.currentTarget.dataset.type);
                });
                inventoryListContainer.querySelectorAll('.edit-btn').forEach(button => {
                    button.onclick = (event) => {
                        const itemId = event.currentTarget.dataset.id;
                        const itemToEdit = window.appState.inventory.find(item => item.id === itemId);
                        if (itemToEdit) window.handleEditClick(itemToEdit);
                    };
                });
                // Directly call handleDeleteItem on click
                inventoryListContainer.querySelectorAll('.delete-btn').forEach(button => {
                    button.onclick = (event) => {
                        const itemId = event.currentTarget.dataset.id;
                        window.handleDeleteItem(itemId); // Direct call
                    };
                });
            }

            // Re-create Lucide icons after DOM updates
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        // --- Event Handlers ---

        window.showMessage = (text, type) => {
            window.appState.message = { text, type };
            window.renderApp();
        };

        window.handleLogout = () => {
            sessionStorage.removeItem('loggedInUser'); // Clear session
            window.location.href = 'index.html'; // Redirect to login
        };

        window.handleAddItem = (e) => {
            e.preventDefault();
            const itemName = itemNameInput.value.trim();
            const itemQuantity = itemQuantityInput.value;
            const itemPrice = itemPriceInput.value;
            const itemDescription = itemDescriptionInput.value.trim();
            const itemImageUrl = itemImageUrlInput.value.trim();

            if (!itemName || !itemQuantity || !itemPrice) {
                window.showMessage('Please fill in all required fields (Name, Quantity, Price).', 'error');
                return;
            }
            if (isNaN(itemQuantity) || isNaN(itemPrice) || parseFloat(itemQuantity) < 0 || parseFloat(itemPrice) < 0) {
                window.showMessage('Quantity and Price must be valid positive numbers.', 'error');
                return;
            }

            const newItemData = {
                id: window.appState.editingItem ? window.appState.editingItem.id : Date.now().toString(), // Use existing ID or generate new
                name: itemName,
                quantity: parseInt(itemQuantity, 10),
                price: parseFloat(itemPrice),
                description: itemDescription,
                imageUrl: itemImageUrl,
                lastUpdated: new Date().toISOString()
            };

            if (window.appState.editingItem) {
                // Update existing item
                const index = window.appState.inventory.findIndex(item => item.id === newItemData.id);
                if (index !== -1) {
                    window.appState.inventory[index] = newItemData;
                    window.showMessage('Item updated successfully!', 'success');
                }
                window.appState.editingItem = null;
            } else {
                // Add new item
                window.appState.inventory.push(newItemData);
                window.showMessage('Item added successfully!', 'success');
            }
            window.appState.inventory.sort((a, b) => a.name.localeCompare(b.name)); // Re-sort
            saveUserInventory(); // Save to localStorage
            
            // Clear form fields
            itemNameInput.value = '';
            itemQuantityInput.value = '';
            itemPriceInput.value = '';
            itemDescriptionInput.value = '';
            itemImageUrlInput.value = '';
            window.appState.isFormOpen = false; // Close form after submission
            window.renderApp(); // Re-render to clear form and close details
        };

        window.handleEditClick = (item) => {
            window.appState.editingItem = item;
            itemNameInput.value = item.name;
            itemQuantityInput.value = item.quantity.toString();
            itemPriceInput.value = item.price.toString();
            itemDescriptionInput.value = item.description || '';
            itemImageUrlInput.value = item.imageUrl || '';
            window.appState.isFormOpen = true; // Open form
            window.renderApp(); // Re-render to update form title/buttons
        };

        window.handleCancelEdit = () => {
            window.appState.editingItem = null;
            itemNameInput.value = '';
            itemQuantityInput.value = '';
            itemPriceInput.value = '';
            itemDescriptionInput.value = '';
            itemImageUrlInput.value = '';
            window.appState.isFormOpen = false; // Close form
            window.renderApp(); // Re-render to clear form and close details
        };

        window.handleQuantityChange = (itemId, changeType) => {
            const item = window.appState.inventory.find(i => i.id === itemId);
            if (item) {
                if (changeType === 'add') {
                    item.quantity += 1;
                } else if (changeType === 'deduct') {
                    if (item.quantity > 0) {
                        item.quantity -= 1;
                    } else {
                        window.showMessage('Quantity cannot go below zero.', 'error');
                        return;
                    }
                }
                item.lastUpdated = new Date().toISOString();
                saveUserInventory(); // Save to localStorage
                window.showMessage('Quantity updated successfully!', 'success');
                window.renderApp(); // Re-render to reflect changes
            }
        };

        // Simplified deletion function
        window.handleDeleteItem = (itemId) => {
            const itemToDelete = window.appState.inventory.find(item => item.id === itemId);
            if (!itemToDelete) return; // Should not happen if button is clicked on existing item

            window.appState.inventory = window.appState.inventory.filter(item => item.id !== itemId);
            saveUserInventory(); // Save to localStorage
            window.showMessage(`"${itemToDelete.name}" deleted successfully!`, 'success');
            window.renderApp(); // Re-render list
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadUserInventory(); // Load inventory from localStorage for the logged-in user
            window.renderApp(); // Initial render

            // Attach event listeners to static elements
            logoutButton.addEventListener('click', window.handleLogout);
            goToBillingButton.addEventListener('click', () => { window.location.href = 'billing.html'; });
            itemForm.addEventListener('submit', window.handleAddItem);
            cancelEditButton.addEventListener('click', window.handleCancelEdit);

            // Event listener for search input
            inventorySearchInput.addEventListener('input', (event) => {
                window.appState.searchTerm = event.target.value;
                window.renderApp(); // Re-render to apply filter
            });

            // Listen for changes in the details element's open state
            itemFormDetails.addEventListener('toggle', (event) => {
                window.appState.isFormOpen = event.target.open;
                // If closing, clear editing state
                if (!event.target.open && window.appState.editingItem) {
                    window.handleCancelEdit(); // This will also re-render
                } else if (event.target.open && !window.appState.editingItem) {
                    // If opening and not in edit mode, ensure form is clear
                    itemNameInput.value = '';
                    itemQuantityInput.value = '';
                    itemPriceInput.value = '';
                    itemDescriptionInput.value = '';
                    itemImageUrlInput.value = '';
                    formTitle.textContent = 'Add New Inventory Item';
                    submitButtonText.textContent = 'Add Item';
                    cancelEditButton.classList.add('hidden');
                }
                // Re-create icons to ensure arrow rotation is applied
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });

            // Initial Lucide icon rendering for static elements
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>
